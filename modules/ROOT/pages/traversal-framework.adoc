:description: The Neo4j traversal framework Java API.

:org-neo4j-graphdb-traversal-TraversalDescription: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html
:TraversalDescription-including-direction: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#relationships-org.neo4j.graphdb.RelationshipType-org.neo4j.graphdb.Direction-
:TraversalDescription-excluding-direction: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#relationships-org.neo4j.graphdb.RelationshipType-
:org-neo4j-graphdb-Direction-both: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/Direction.html#BOTH
:org-neo4j-graphdb-traversal-Evaluator: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/Evaluator.html
:org-neo4j-graphdb-traversal-Evaluators: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/Evaluators.html
:org-neo4j-graphdb-traversal-Traverser: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/Traverser.html

:org-neo4j-graphdb-traversal-TraversalDescription: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html
:TraversalDescription-traverse: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#traverse-org.neo4j.graphdb.Node-

:org-neo4j-graphdb-traversal-Uniqueness: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/Uniqueness.html
:Uniqueness-NODE-GLOBAL: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/Uniqueness.html#NODE_GLOBAL

:TraversalDescription-order: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#order-org.neo4j.graphdb.traversal.BranchOrderingPolicy-
:org-neo4j-graphdb-traversal-BranchOrderingPolicies: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/BranchOrderingPolicies.html

:org-neo4j-graphdb-traversal-BranchOrderingPolicy: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/BranchOrderingPolicy.html

:org-neo4j-graphdb-Path: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/Path.html

:TraversalDescription-depthFirst: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#depthFirst--
:TraversalDescription-breadthFirst: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalDescription.html#breadthFirst--

:org-neo4j-graphdb-traversal-TraversalBranch: {neo4j-javadocs-base-uri}/org/neo4j/graphdb/traversal/TraversalBranch.html


[[traversal]]
= The traversal framework

This section provides an overview of the concepts of the traversal framework, and a detailed description of the Neo4j traversal framework Java API.

The Neo4j Traversal framework Java API is a callback-based, lazily-executed way of specifying desired movements through a graph in Java.
Some traversal examples are collected under xref:java-embedded/traversal.adoc[].

You can also use the link:{neo4j-docs-base-uri}/cypher-manual/{neo4j-version}/[Cypher query language] as a powerful declarative way to query the graph.


[[traversal-concepts]]
== Main concepts

Below is a short explanation of all different methods that can modify or add to a traversal description.

* _Pathexpanders_ -- define what to traverse, typically in terms of relationship direction and type.
* _Order_ -- for example depth-first or breadth-first.
* _Uniqueness_ -- visit nodes (relationships, paths) only once.
* _Evaluator_ -- decide what to return and whether to stop or continue traversal beyond the current position.
* _Starting nodes_ where the traversal will begin.

image::graphdb-traversal-description.svg[role="middle"]


[[traversal-java-api]]
== Traversal framework Java API

The traversal framework consists of a few main interfaces in addition to `Node` and `Relationship`: `TraversalDescription`, `Evaluator`, `Traverser` and `Uniqueness` are the main ones.
The `Path` interface also has a special purpose in traversals, since it is used to represent a position in the graph when evaluating that position.
Furthermore the `PathExpander` (replacing `RelationshipExpander` and `Expander`) interface is central to traversals, but users of the API rarely need to implement it.
There are also a set of interfaces for advanced use, when explicit control over the traversal order is required: `BranchSelector`, `BranchOrderingPolicy` and `TraversalBranch`.


[[traversal-java-api-traversaldescription]]
=== TraversalDescription

The link:{org-neo4j-graphdb-traversal-TraversalDescription}[`org.neo4j.graphdb.traversal.TraversalDescription`^] is the main interface used for defining and initializing traversals.
It is not meant to be implemented by users of the traversal framework, but rather to be provided by the implementation of the traversal framework as a way for the user to describe traversals.
`TraversalDescription` instances are immutable and its methods returns a new `TraversalDescription` that is modified compared to the object the method was invoked on with the arguments of the method.


==== Relationships

Adds a relationship type to the list of relationship types to traverse.
By default this list is empty and it means that it will traverse _all relationships_, regardless of type.
If one or more relationships are added to this list _only the added_ types will be traversed.
There are two methods, one link:{TraversalDescription-including-direction}[`including direction`^] and another one link:{TraversalDescription-excluding-direction}[`excluding direction`^], where the latter traverses relationships in link:{org-neo4j-graphdb-Direction-both}[`both directions`^].


[[traversal-java-api-evaluator]]
=== Evaluator

The link:{org-neo4j-graphdb-traversal-Evaluator}[`org.neo4j.graphdb.traversal.Evaluator`^] is used for deciding, at each position (represented as a `Path`) whether the traversal should continue, and/or whether the node should be included in the result.

Given a `Path`, it asks for one of four actions for that branch of the traversal:

* `Evaluation.INCLUDE_AND_CONTINUE`: Include this node in the result and continue the traversal.
* `Evaluation.INCLUDE_AND_PRUNE`: Include this node in the result, but do not continue the traversal.
* `Evaluation.EXCLUDE_AND_CONTINUE`: Exclude this node from the result, but continue the traversal.
* `Evaluation.EXCLUDE_AND_PRUNE`: Exclude this node from the result and do not continue the traversal.

More than one evaluator can be added.

[NOTE]
====
Evaluators will be called for all positions the traverser encounters, even for the start node.
====

[[traversal-java-api-traverser]]
=== Traverser

The link:{org-neo4j-graphdb-traversal-Traverser}[`org.neo4j.graphdb.traversal.Traverser`^] object is the result of invoking link:{TraversalDescription-traverse}[`traverse()`^] of a link:{org-neo4j-graphdb-traversal-TraversalDescription}[`org.neo4j.graphdb.traversal.TraversalDescription`^] object.
It represents a traversal positioned in the graph, and a specification of the format of the result.
The actual traversal is performed lazily each time the `next()`-method of the iterator of the `Traverser` is invoked.


[[traversal-java-api-uniqueness]]
=== Uniqueness

Sets the rules for how positions can be revisited during a traversal as stated in link:{org-neo4j-graphdb-traversal-Uniqueness}[`org.neo4j.graphdb.traversal.Uniqueness`^].
Default if not set is link:{Uniqueness-NODE-GLOBAL}[`NODE_GLOBAL`^].

A Uniqueness can be supplied to the `TraversalDescription` to dictate under what circumstances a traversal may revisit the same position in the graph.
The various uniqueness levels that can be used in Neo4j are:

* `NONE`: Any position in the graph may be revisited.
* `NODE_GLOBAL` uniqueness: No node in the entire graph may be visited more than once.
This could potentially consume a lot of memory since it requires keeping an in-memory data structure remembering all the visited nodes.
* `RELATIONSHIP_GLOBAL` uniqueness: no relationship in the entire graph may be visited more than once.
Just like `NODE_GLOBAL` uniqueness, this could potentially use up a lot of memory.
But since graphs typically have a larger number of relationships than nodes, the memory overhead of this uniqueness level could grow even quicker.
* `NODE_PATH` uniqueness: A node may not occur previously in the path reaching up to it.
* `RELATIONSHIP_PATH` uniqueness: A relationship may not occur previously in the path reaching up to it.
* `NODE_RECENT` uniqueness: Similar to `NODE_GLOBAL` uniqueness in that there is a global collection of visited nodes each position is checked against.
This uniqueness level does however have a cap on how much memory it may consume in the form of a collection that only contains the most recently visited nodes.
The size of this collection can be specified by providing a number as the second argument to the TraversalDescription.uniqueness()-method along with the uniqueness level.
* `RELATIONSHIP_RECENT` uniqueness: Works like `NODE_RECENT` uniqueness, but with relationships instead of nodes.


==== Depth first / Breadth first

These are convenience methods for setting preorder link:https://en.wikipedia.org/wiki/Depth-first_search[depth-first^] / link:https://en.wikipedia.org/wiki/Breadth-first_search[breadth-first^] `BranchSelector` | `ordering` policies.
The same result can be achieved by calling the link:{TraversalDescription-order}[`order`^] method with ordering policies from link:{org-neo4j-graphdb-traversal-BranchOrderingPolicies}[`org.neo4j.graphdb.traversal.BranchOrderingPolicies`^], or to write your own `BranchSelector` / `BranchOrderingPolicy` and pass in.


[[traversal-java-api-order]]
=== Order - how to move through branches?

This is a more generic version of depthFirst/ breadthFirst methods in that it enables an arbitrary link:{org-neo4j-graphdb-traversal-BranchOrderingPolicy}[`org.neo4j.graphdb.traversal.BranchOrderingPolicy`^] to be injected into the description.


[[traversal-java-api-branchselector]]
=== BranchSelector

A `BranchSelector` / `BranchOrderingPolicy` is used for selecting which branch of the traversal to attempt next.
This is used for implementing traversal orderings.
The traversal framework provides a few basic ordering implementations:

* `BranchOrderingPolicies.PREORDER_DEPTH_FIRST`: Traversing depth first, visiting each node before visiting its child nodes.
* `BranchOrderingPolicies.POSTORDER_DEPTH_FIRST`: Traversing depth first, visiting each node after visiting its child nodes.
* `BranchOrderingPolicies.PREORDER_BREADTH_FIRST`: Traversing breadth first, visiting each node before visiting its child nodes.
* `BranchOrderingPolicies.POSTORDER_BREADTH_FIRST`: Traversing breadth first, visiting each node after visiting its child nodes.

[NOTE]
====
Breadth-first traversals have a higher memory overhead than depth-first traversals.
====

A `BranchSelector` carries state and hence needs to be uniquely instantiated for each traversal.
Therefore it is supplied to the `TraversalDescription` through a `BranchOrderingPolicy` interface, which is a factory of `BranchSelector` instances.

A user of the Traversal framework rarely needs to implement his own `BranchSelector` or `BranchOrderingPolicy`, it is provided to let graph algorithm implementors provide their own traversal orders.
The Neo4j Graph Algorithms package contains for example a `BestFirst` order `BranchSelector` / `BranchOrderingPolicy` that is used in BestFirst search algorithms such as A* and Dijkstra.


==== BranchOrderingPolicy

A factory for creating ``BranchSelector``s to decide in what order branches are returned (where a branch's position is represented as a link:{org-neo4j-graphdb-Path}[`Path`^] from the start node to the current node).
Common policies are link:{TraversalDescription-depthFirst}[`depth-first`^] and link:{TraversalDescription-breadthFirst}[`breadth-first`^] and that is why there are convenience methods for those.

For example, calling `TraversalDescription#depthFirst()` is equivalent to:

[source, java, role="nocopy"]
----
description.order( BranchOrderingPolicies.PREORDER_DEPTH_FIRST );
----


==== TraversalBranch

An object used by the BranchSelector to get more branches from a certain branch.
In essence these are a composite of a Path and a RelationshipExpander that can be used to get a new link:{org-neo4j-graphdb-traversal-TraversalBranch}[`org.neo4j.graphdb.traversal.TraversalBranch`^] from the current one.


[[traversal-java-api-path]]
=== Path

A link:{org-neo4j-graphdb-Path}[`org.neo4j.graphdb.Path`^] is a general interface that is part of the Neo4j API.
In the traversal API of Neo4j the use of Paths are twofold.
Traversers can return their results in the form of the Paths of the visited positions in the graph that are marked for being returned.
Path objects are also used in the evaluation of positions in the graph, for determining if the traversal should continue from a certain point or not, and whether a certain position should be included in the result set or not.


[[traversal-java-api-pathexpander]]
=== PathExpander / RelationshipExpander

The traversal framework use the `PathExpander` (replacing `RelationshipExpander`) to discover the relationships that should be followed from a particular path to further branches in the traversal.


[[traversal-java-api-expander]]
=== Expander

This is a more generic version of relationships where a `RelationshipExpander` is injected, defining all relationships to be traversed for any given node.

The `Expander` interface is an extension of the `RelationshipExpander` interface that makes it possible to build customized versions of an `Expander`.
The implementation of `TraversalDescription` uses this to provide methods for defining which relationship types to traverse, this is the usual way a user of the API would define a `RelationshipExpander` -- by building it internally in the `TraversalDescription`.

All the RelationshipExpanders provided by the Neo4j traversal framework also implement the Expander interface.
For a user of the traversal API it is easier to implement the PathExpander/RelationshipExpander interface, since it only contains one method -- the method for getting the relationships from a path/node, the methods that the Expander interface adds are just for building new Expanders.

[[examples-how-to-use-the-traversal-framework]]
=== How to use the Traversal framework

A link:{org-neo4j-graphdb-traversal-TraversalDescription}[`org.neo4j.graphdb.traversal.TraversalDescription`^] is built using a fluent interface and such a description can then spawn several link:{org-neo4j-graphdb-traversal-Traverser}[`org.neo4j.graphdb.traversal.Traverser`^] objects.

image::traversal_framework_example.svg[role="middle"]

[NOTE]
====
The source code for the examples can be found here: link:https://github.com/neo4j/neo4j-documentation/blob/3.5/embedded-examples/src/main/java/org/neo4j/examples/TraversalExample.java[`TraversalExample.java`^].
====

With the definition of the RelationshipTypes as:

[source, java]
----
private enum Rels implements RelationshipType
{
    LIKES, KNOWS
}
----

The graph can be traversed with for example the following traverser, starting at the node with the `name = 'Joe'`:

[source, java]
----
for ( Path position : db.traversalDescription()
        .depthFirst()
        .relationships( Rels.KNOWS )
        .relationships( Rels.LIKES, Direction.INCOMING )
        .evaluator( Evaluators.toDepth( 5 ) )
        .traverse( node ) )
{
    output += position + "\n";
}
----

The traversal will output:

[source, output, role="noheader"]
----
(0)
(0)<-[LIKES,1]-(5)
(0)<-[LIKES,1]-(5)-[KNOWS,6]->(1)
(0)<-[LIKES,1]-(5)-[KNOWS,6]->(1)<-[KNOWS,5]-(6)
(0)<-[LIKES,1]-(5)-[KNOWS,6]->(1)-[KNOWS,4]->(4)
(0)<-[LIKES,1]-(5)-[KNOWS,6]->(1)-[KNOWS,4]->(4)-[KNOWS,3]->(3)
(0)<-[LIKES,1]-(5)-[KNOWS,6]->(1)-[KNOWS,4]->(4)-[KNOWS,3]->(3)-[KNOWS,2]->(2)
----

Since a `TraversalDescription` is immutable it is also useful to create template descriptions which holds common settings shared by different traversals.
For example, start with this traverser:

[source, java]
----
friendsTraversal = db.traversalDescription()
        .depthFirst()
        .relationships( Rels.KNOWS )
        .uniqueness( Uniqueness.RELATIONSHIP_GLOBAL );
----


This traverser would yield the following output (starting from the node with the `name = 'Joe'`):

[source, java]
----
(0)
(0)-[KNOWS,0]->(2)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)<-[KNOWS,4]-(1)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)<-[KNOWS,4]-(1)<-[KNOWS,6]-(5)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)<-[KNOWS,4]-(1)<-[KNOWS,5]-(6)
----

Create a new traverser from it, restricting depth to three:

[source, java]
----
for ( Path path : friendsTraversal
        .evaluator( Evaluators.toDepth( 3 ) )
        .traverse( node ) )
{
    output += path + "\n";
}
----

This will give the following output:

[source, output, role="noheader"]
----
(0)
(0)-[KNOWS,0]->(2)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)
----


Or how about from depth two to four?
That is done like this:

[source, java]
----
for ( Path path : friendsTraversal
        .evaluator( Evaluators.fromDepth( 2 ) )
        .evaluator( Evaluators.toDepth( 4 ) )
        .traverse( node ) )
{
    output += path + "\n";
}
----

This will give the following output:

[source, output, role="noheader"]
----
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)
(0)-[KNOWS,0]->(2)<-[KNOWS,2]-(3)<-[KNOWS,3]-(4)<-[KNOWS,4]-(1)
----

For various useful evaluators, see the link:{org-neo4j-graphdb-traversal-Evaluators}[`org.neo4j.graphdb.traversal.Evaluators`^] Java API or simply implement the link:{org-neo4j-graphdb-traversal-Evaluator}[`org.neo4j.graphdb.traversal.Evaluator`^] interface yourself.

If you are not interested in the Paths, but the Nodes you can transform the traverser into an iterable of nodes like this:

[source, java]
----
for ( Node currentNode : friendsTraversal
        .traverse( node )
        .nodes() )
{
    output += currentNode.getProperty( "name" ) + "\n";
}
----

This will give the following output:

[source, output, role="noheader"]
----
Joe
Sara
Peter
Dirk
Lars
Lisa
Ed
----

Relationships are fine as well, here is an example how to get them:

[source, java]
----
for ( Relationship relationship : friendsTraversal
        .traverse( node )
        .relationships() )
{
    output += relationship.getType().name() + "\n";
}
----


[source, output, role="noheader"]
----
KNOWS
KNOWS
KNOWS
KNOWS
KNOWS
KNOWS
----

